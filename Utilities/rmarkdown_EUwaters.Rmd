---
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r region subset,include=FALSE}

# set the region of interest
  s_reg         <- subset(shape_ices_EEZ,shape_ices_EEZ$Eco_EEZ %in% Region_ID)
  s_scen11_prev <- st_intersection(st_make_valid(scen11_prev),s_reg)
  s_scen12_prev <- st_intersection(st_make_valid(scen12_prev),s_reg)
  s_scen21_prev <- st_intersection(st_make_valid(scen21_prev),s_reg)
  s_scen22_prev <- st_intersection(st_make_valid(scen22_prev),s_reg)
  s_scen23_prev <- st_intersection(st_make_valid(scen23_prev),s_reg)
  s_scen11      <- st_intersection(st_make_valid(scen11),s_reg)
  s_scen12      <- st_intersection(st_make_valid(scen12),s_reg)
  s_scen21      <- st_intersection(st_make_valid(scen21),s_reg)
  s_scen22      <- st_intersection(st_make_valid(scen22),s_reg)
  s_scen23      <- st_intersection(st_make_valid(scen23),s_reg)
  s_shapeEEZ    <- s_reg
  s_EUFootp     <- st_intersection(EUFootp,s_reg)
  s_Ref_comb    <- st_intersection(Ref_comb,s_reg)
  s_Ref_mobile  <- st_intersection(Ref_mobile,s_reg)
  s_Ref_static  <- st_intersection(Ref_static,s_reg)
  s_New_comb    <- st_intersection(New_comb,s_reg)
  s_New_mobile  <- st_make_valid(st_intersection(New_mobile,s_reg))
  s_New_static  <- st_intersection(New_static,s_reg)
  #s_NEAFCFootp  <- st_intersection(NEAFCFootp,s_reg)
  #s_NEAFCReg    <- st_intersection(NEAFCReg,s_reg)
  #s_clos_neafc  <- st_intersection(clos_neafc,s_reg)
  s_clos_eu  <- st_intersection(clos_eu,s_reg) %>% st_make_valid()
  
  s_VMEgrid_new <- st_intersection(VMEgrid_new,s_reg)
  s_VMEgrid_old <- st_intersection(VMEgrid_old,s_reg)
  s_Elements    <- st_intersection(Elements,s_reg)
  s_Reg_depth   <- st_intersection(Reg_depth,s_reg)
  s_vmedb_sf <- st_intersection(st_make_valid(vmedb_sf),st_make_valid(s_Reg_depth))
  
```


### Ecoregion Overview {.tabset } 
```{r , results = 'asis'}
tt <- subset(textreg,textreg$Tab == "Overview")
for(i in 1:nrow(tt)){
  cat(tt[i,3])
  }
```

The VME database contains
```{r , results = 'asis'}
cat(as.numeric(table(s_VMEgrid_new$VME_Class ==3)["TRUE"]))
```
VME habitat and
```{r , results = 'asis'}
cat(as.numeric(table(s_VMEgrid_new$VME_Class %in% c(0,1,2))["TRUE"]))
```
VME indicator c-squares in this area (based on the
```{r , results = 'asis'}
cat(datacallyear)
```
VME data call). This information has been collected through various gear types and survey methods. 

### New VME data {.tabset } 
Previously, 
```{r, results='asis'}
  reg  <- subset(table1,table1$Ecoregion %in% Region_ID)  
  cat(sum(reg$Exist_VMEs ==3, na.rm = TRUE))
```
VME habitat c-squares and
```{r, results='asis'}
  cat(sum(reg$Exist_VMEs %in% c(0:2), na.rm = TRUE))
```
VME Index c-squares were identified

```{r, results='asis'}
if (length(!is.na(reg$New_VMEs))==0){
  cat("This latest assesment has not identified additional VME Habitat or Index c-squares.")
  } else {
    glue("
  New VME habitat and indicator records were submitted and quality checked. This resulted in \\
  {sum(reg$New_VMEs==3, na.rm = TRUE)} new VME Habitat c-squares and \\
  {sum(reg$New_VMEs %in% c(0:2), na.rm = TRUE)} new VME Index c-squares; \\
  {sum(reg$New_VMEs %in% 2, na.rm = TRUE)} index High, \\
  {sum(reg$New_VMEs %in% 1, na.rm = TRUE)} index Medium and \\
  {sum(reg$New_VMEs %in% 0, na.rm = TRUE)} index Low."
  )
  
}
```

<br>

```{r , results = 'asis'}
tt <- subset(textreg,textreg$Tab == "New VME data")
for(i in 1:nrow(tt)){
  cat(tt[i,3])
  }
```

#### Map of VMEs
Information on VME Habitat and Index C-squares and the spatial distribution of static and mobile bottom-fishing
<br> 
```{r Build option map, include=FALSE}
# select all new c-squares
# does this work when c-squares are being removed? / if updated it works!
  s_VMEgrid_old$uni  <- paste(s_VMEgrid_old$csquares,s_VMEgrid_old$VME_Class)  
  s_VMEgrid_new$uni  <- paste(s_VMEgrid_new$csquares,s_VMEgrid_new$VME_Class)
  s_VMEgrid_new      <- s_VMEgrid_new[!(s_VMEgrid_new$uni %in% s_VMEgrid_old$uni ),]

  
# names for the leaflet
  nam <- c("EEZ boundaries","Depth zone 400-800m",
           "Existing VME C-sq.","New VME C-sq.","EU fishable domain (prelim.)",
           "Fished area (S+M)","Reference fished area (S)","Fished area (S)",
           "Reference fished area (M)","Fished area (M)",
           "Existing VME physical elements","Updated VME physical elements (prelim.)",
           "EU Closures")

# Create colour palette for VMEs
  VMEcolours <- c("#2E8AC6","#F40000","#F67E11","#FDF100")
  VMEpal <- colorFactor(VMEcolours, VMEgrid_old$VME_Class_Lab)  
  
# set region
  mxt <- st_bbox(s_reg)
  
# 
  mfs <- leaflet() %>%
    fitBounds(mxt[[1]],mxt[[2]],mxt[[3]],mxt[[4]]) %>%
    addProviderTiles(providers$Esri.WorldImagery) %>%
   # boundaries
    addPolygons(data = s_reg, group = nam[1],
                stroke = TRUE, fillOpacity = 0, smoothFactor = 0.5, opacity = 0.5, weight = 1, color = "white") %>%
    addPolygons(data = s_Reg_depth, group = nam[2],
               stroke = TRUE, fillOpacity = 0.1, smoothFactor = 0.5, opacity = 0.5, weight = 1, color = "yellow") %>%
    
    # VME c-sqs
    addPolygons(data = s_VMEgrid_old, group = nam[3],
                stroke = FALSE, fillOpacity = 1, smoothFactor = 0.5,
                color = ~VMEpal(VME_Class_Lab)) %>%
    
    addPolygons(data = s_VMEgrid_new, group = nam[4],
                stroke = FALSE, fillOpacity = 1, smoothFactor = 0.5,
                color = ~VMEpal(VME_Class_Lab)) %>%
    
    # EU footprint and fishing areas
    addPolygons(data = s_EUFootp, group = nam[5],
                stroke = FALSE, fillOpacity = 0.5, smoothFactor = 0.5, fillColor =  "white") %>%
    
    addPolygons(data = s_New_comb, group = nam[6],
                stroke = FALSE, fillOpacity = 0.5, smoothFactor = 0.5, fillColor =  "red") %>%
    
    addPolygons(data = s_Ref_static, group = nam[7],
               stroke = FALSE, fillOpacity = 0.5, smoothFactor = 0.5, fillColor =  "white") %>%
    
    addPolygons(data = s_New_static, group = nam[8],
                stroke = FALSE, fillOpacity = 0.5, smoothFactor = 0.5, fillColor =  "red") %>%
    
    addPolygons(data = s_Ref_mobile, group = nam[9],
                stroke = FALSE, fillOpacity = 0.5, smoothFactor = 0.5, fillColor =  "white") %>%
    
    addPolygons(data = s_New_mobile, group = nam[10],
                stroke = FALSE, fillOpacity = 0.5, smoothFactor = 0.5, fillColor =  "red") %>%
    
    # elements
    addPolygons(data = s_Elements, group = nam[11],
                stroke = FALSE, fillOpacity = 0.5, smoothFactor = 0.5, fillColor =  "white") %>%
    
    addPolygons(data = s_Elements, group = nam[12],
                stroke = FALSE, fillOpacity = 0.5, smoothFactor = 0.5, fillColor =  "red") %>%
   
    addLegend(group = "VME Class",
              position = "bottomright",
              colors = VMEcolours, labels= levels(s_VMEgrid_old$VME_Class_Lab)) %>%
    
    # Closures
    addPolygons(data = s_clos_eu, group = nam[13],
                stroke = FALSE, fillOpacity = 0.5, smoothFactor = 0.5, fillColor =  "black") %>% 
  
    # Layers control
    addLayersControl(
      overlayGroups = nam)%>%
    
    # hide 
    hideGroup(nam[4:12])
```

```{r echo=FALSE, message=FALSE,fig.asp=0.8,out.width='85%', fig.cap="** **"}

mfs

```

#### Key to map layers

```{r map1 key}
map1layers <- map1layers[-c(1,14:16),] 
map1layers[,-2] %>%
  kbl('html',escape = FALSE, align='l',col.names = c('Layer','Description'),row.names = F) %>%
  kable_classic(full_width = F, position = "center",fixed_thead = T,font_size = 10,html_font = "Times") %>%
  row_spec(0, bold = T)  %>%
  row_spec(0:nrow(map1layers), extra_css = 'padding: 10px;vertical-align:top;') %>%
  column_spec(1, width = "5cm") %>%
  column_spec(2, width = "12cm")

```


#### Overlap VME c-sqs and fishing 
Summary table of overlap between fishing activities and new and cumulative VME evidence at the scale of C-squares. 
<br>
```{r, echo=FALSE, message=FALSE, out.width='80%',fig.align = 'center', fig.cap="** **"}

  # Subset data to region
  reg  <- subset(table1,table1$Ecoregion %in% Region_ID)  
  
  #sum(table(reg$cat)) # get total assessed area - add to the table text
  source(paste(pathdir,"Utilities/Compile_table1.R",sep="/"))

  tab1[is.na(tab1)] <- ""
  tab1 %>% select(-c(4,5,9,10)) %>% 
    filter(!if_any(1, ~. %in% c("200-400m", ">800m"))) %>% 
    kable('html',escape = FALSE, align=c('l',rep('c',7)),row.names = FALSE,col.names = c('','All','Mobile gears',' ','All', 'Mobile gears',' ', 'All')) %>%
    kable_classic(full_width = F, position = "center",fixed_thead = T,font_size = 10,html_font = "Times") %>%
    row_spec(0, bold = T, extra_css = 'padding: 3.5px;vertical-align:top;')  %>%
    row_spec(c(1,3,5,7),bold = T, background = icespal[['lg']], extra_css = 'padding: 3px;vertical-align:top;') %>%
    row_spec(c(2,4,6,8:11), extra_css = 'padding: 1.5px;vertical-align:top;') %>%
    column_spec(1, width = "6cm") %>%
    column_spec(3:6, width = "5cm") %>%
    column_spec(c(2,5,8), width = "5cm") %>%
    column_spec(c(4,7), width = ".8cm") %>%
    add_header_above(c(" " = 1, "Assessed area" = 1,"Areas fished between 2018-2020" = 1," "=1, "Assessed area" = 1, "Areas fished between 2018-2020" = 1, " "=1, "Assessed area" = 1),bold = TRUE,line_sep = 4,line = TRUE, extra_css = 'padding: 3px;vertical-align:top;') %>%
    add_header_above(c(" " = 1,'Existing' = 2," "=1, 'New/updated in 2021'=2, " "=1, 'Total'=1),bold = TRUE,line_sep = 10, extra_css = 'padding: 3px;vertical-align:top;') %>%
    add_header_above(c(" " = 1,"Number of VME/VME element c-squares" = 7),bold = TRUE, extra_css = 'padding: 3px;vertical-align:top;')
```
#### Overlap between new and previously defined VME c-sqs    
Summary table of overlap between new and updated VME C-squares and already defined VME closures.
<br>
```{r, echo=FALSE, message=FALSE, out.width='80%',fig.align = 'center', fig.cap="** **"}
  
  tab1b[is.na(tab1b)] <- ""
  
  tab1b %>% 
    filter(!if_any(1, ~. %in% c("200-400m", ">800m"))) %>%
    kable('html',escape = FALSE, align=c('l',rep('c',7)),row.names = FALSE,col.names = c('','All', 'S1O1',' S1O2', 'S2O1','S2O2','S1O2+S2O1', 'All')) %>%
    kable_classic(full_width = F, position = "center",fixed_thead = T,font_size = 10,html_font = "Times") %>%
    row_spec(0, bold = T, extra_css = 'padding: 3.5px;vertical-align:top;')  %>%
    row_spec(c(1,3,5,7),bold = T, background = icespal[['lg']], extra_css = 'padding: 3px;vertical-align:top;') %>%
    row_spec(c(2,4,6,8:11), extra_css = 'padding: 1.5px;vertical-align:top;') %>%
    column_spec(1, width = "6cm") %>%
    column_spec(2:7, width = "2.5cm") %>%
    add_header_above(c(" " = 1, "Assessed area" = 1, "In defined VME polygons" = 5, "EU closures" = 1),bold = TRUE,line_sep = 4,line = TRUE, extra_css = 'padding: 3px;vertical-align:top;') %>%
    add_header_above(c(" " = 1,'New/updated in 2021'=7),bold = TRUE,line_sep = 10, extra_css = 'padding: 3px;vertical-align:top;') %>%
    add_header_above(c(" " = 1,"Number of VME/VME element c-squares" = 7),bold = TRUE, extra_css = 'padding: 3px;vertical-align:top;')

```

### VME polygon options {.tabset } 

```{r , results = 'asis'}
tt <- subset(textreg,textreg$Tab == "VME polygons")
for(i in 1:nrow(tt)){
  cat(tt[i,3])
  }
```

#### Map of updated VME polygons
Update of the VME polygons following the scenarios/options.
<br>
```{r Build option map2, include=FALSE}

nam <- c("EEZ boundaries", 
           "Depth zone 400-800m (prelim.)",
           "Existing VME C-sq.","New VME C-sq.",
           "Existing VME polygon S1 O1","New VME polygon S1 O1",
           "Existing VME polygon S1 O2","New VME polygon S1 O2",
           "Existing VME polygon S2 O1","New VME polygon S2 O1",
           "Existing VME polygon S2 O2","New VME polygon S2 O2",
           "Exist. VME pol. S1O2 + S2O1","New VME pol. S1O2 + S2O1",
           "EU fishable domain (prelim.)", "EU Closures")

# Colourpalette for options
optpalOld <- c('#ffe599','#ffc4c4','#9fc5e8','#eeeeee','#b4a7d6')
optpalNew <- c('#e5ce89','#e5b0b0','#8fb1d0','#d6d6d6','#a296c0')
  

mfs2 <- leaflet() %>%
    fitBounds(mxt[[1]],mxt[[2]],mxt[[3]],mxt[[4]]) %>%
    addProviderTiles(providers$Esri.WorldImagery) %>%
    addMapPane("scens", zIndex = 420) %>%
    # boundaries
    addPolygons(data = s_shapeEEZ, group = nam[1],
                stroke = TRUE, fillOpacity = 0, smoothFactor = 0.5, opacity = 0.5, weight = 1, color = "white") %>%
    addPolygons(data = s_Reg_depth, group = nam[2],
                stroke = TRUE, fillOpacity = 0.1, smoothFactor = 0.5, opacity = 0.5, weight = 1, color = "yellow") %>%

    addPolygons(data = s_scen11_prev, group=nam[5],
                stroke = TRUE, fillOpacity = 0.4, smoothFactor = 0.5, opacity = 0.5, weight = 2, color = optpalOld[1]) %>%
    addPolygons(data = s_scen12_prev, group=nam[7],
                stroke = TRUE, fillOpacity = 0.4, smoothFactor = 0.5, opacity = 0.5, weight = 2, color = optpalOld[2]) %>%
    addPolygons(data = s_scen21_prev, group=nam[9],
                stroke = TRUE, fillOpacity = 0.4, smoothFactor = 0.5, opacity = 0.5, weight = 2, color = optpalOld[3]) %>%
    addPolygons(data = s_scen22_prev, group=nam[11],
                stroke = TRUE, fillOpacity = 0.4, smoothFactor = 0.5, opacity = 0.5, weight = 2, color = optpalOld[4]) %>%
    addPolygons(data = s_scen23_prev, group=nam[13],
                stroke = TRUE, fillOpacity = 0.4, smoothFactor = 0.5, opacity = 0.5, weight = 2, color = optpalOld[5]) %>%  
  
    # potential closures
    addPolygons(data = s_scen11,
                group = nam[6],
                layerId = s_scen11$id,
                stroke = FALSE, 
                fillOpacity = 0.7,
                #fillColor =  "white",
                fillColor =  optpalNew[1],
                color = "transparent",
                highlightOptions = highlightOptions(stroke='white',
                                                    color = "white",
                                                    fillOpacity = 1,
                                                    weight = 2,),
                popup = s_scen11$popTbl,
                options = pathOptions(pane = "scens")) %>%
    addPolygons(data = s_scen12, 
                group=nam[8],
                layerId = s_scen12$id,
                stroke = FALSE, 
                fillOpacity = 0.7,
                #fillColor =  "white",
                fillColor =  optpalNew[2],
                color = "transparent",
                highlightOptions = highlightOptions(stroke='white',
                                                    color = "white",
                                                    fillOpacity = 1,
                                                    weight = 2,),
                popup = s_scen12$popTbl,
                options = pathOptions(pane = "scens")) %>%
    addPolygons(data = s_scen21, 
                group=nam[10],
                layerId = s_scen21$id,
                stroke = FALSE, 
                fillOpacity = 0.7,
                #fillColor =  "white",
                fillColor =  optpalNew[3],
                color = "transparent",
                highlightOptions = highlightOptions(stroke='white',
                                                    color = "white",
                                                    fillOpacity = 1,
                                                    weight = 2,),
                popup = s_scen21$popTbl,
                options = pathOptions(pane = "scens")) %>%
    addPolygons(data = s_scen22, 
                group=nam[12],
                layerId = s_scen22$id,
                stroke = FALSE, 
                fillOpacity = 0.7,
                #fillColor =  "white",
                fillColor =  optpalNew[4],
                color = "transparent",
                highlightOptions = highlightOptions(stroke='white',
                                                    color = "white",
                                                    fillOpacity = 1,
                                                    weight = 2,),
                popup = s_scen22$popTbl,
                options = pathOptions(pane = "scens")) %>%

    addPolygons(data = s_scen23, 
                group=nam[14],
                layerId = s_scen23$id,
                stroke = FALSE, 
                fillOpacity = 0.7,
                #fillColor =  "white",
                fillColor =  optpalNew[5],
                color = "transparent",
                highlightOptions = highlightOptions(stroke='white',
                                                    color = "white",
                                                    fillOpacity = 1,
                                                    weight = 2,),
                popup = s_scen23$popTbl,
                options = pathOptions(pane = "scens")) %>%
    
    
    # existing footprints

    addPolygons(data = s_EUFootp, group = nam[15],
                stroke = FALSE, fillOpacity = 0.5, smoothFactor = 0.5, fillColor =  "white") %>%
  
    # VME csquares
  
    addPolygons(data = s_VMEgrid_old, group = nam[3],
                stroke = FALSE, fillOpacity = 1, smoothFactor = 0.5,
                color = ~VMEpal(VME_Class_Lab)) %>%
    
    addPolygons(data = s_VMEgrid_new, group = nam[4],
                stroke = FALSE, fillOpacity = 1, smoothFactor = 0.5,
                color = ~VMEpal(VME_Class_Lab)) %>%
    
   # Closures
    addPolygons(data = s_clos_eu, group = nam[16],
                stroke = FALSE, fillOpacity = 0.5, smoothFactor = 0.5, fillColor =  "black") %>% 
   # Layers control
    addLayersControl(
      overlayGroups = nam)%>%
  
  # hide 
  hideGroup(nam[c(6:15)])

```

```{r echo=FALSE, message=FALSE,fig.asp=0.8,out.width='85%', fig.cap="** **"}

mfs2

```

#### Key to map layers

```{r map2 key}
map2layers <- map2layers[-c(1,4,15,16),] 
map2layers[,-2] %>%
  kbl('html',escape = FALSE, align='l',row.names=F,col.names = c('Layer','Description')) %>%
  kable_classic(full_width = F, position = "center",fixed_thead = T,font_size = 10,html_font = "Times") %>%
  row_spec(0, bold = T)  %>%
  row_spec(0:nrow(map2layers), extra_css = 'padding: 10px;vertical-align:top;') %>%
  column_spec(1, width = "4.5cm") %>%
  column_spec(2, width = "12cm")

```

#### Scenario options
```{r }

scenop %>%
  kbl('html',escape = FALSE, align='l',col.names = c('Scenario','Option',
                                                     'Description of C-square closures',
                                                     'Management implication')) %>%
  kable_classic(full_width = F, position = "center",fixed_thead = T,font_size = 10,html_font = "Times") %>%
  row_spec(0, bold = T)  %>%
  row_spec(0:nrow(scenop), extra_css = 'padding: 10px;vertical-align:top;') %>%
  column_spec(1, width = "3cm") %>%
  column_spec(2, width = "3cm") %>%
  column_spec(3, width = "12cm") %>%
  column_spec(4, width = "12cm")

```

#### Scenario outcomes and risks

Summary table of scenario outcomes and associated risk to VMEs.
```{r echo=FALSE, message=FALSE, out.width='70%',fig.align = 'center', fig.cap="** **"}

  source(paste(pathdir,"Utilities/Compile_table2_EUVME.R",sep="/")) # warnings okay
  tab2[is.na(tab2)] <- "" 
  
  tab2[c(10,11),2:6] <- NA
  #tab2[10,2:6] <- NA

  tab2[-11,]  %>%
    kable('html',escape = FALSE, align='l',row.names = FALSE) %>%
    kable_classic(full_width = F, position = "center",fixed_thead = T,font_size = 10,html_font = "Times") %>%
    row_spec(0, bold = T, extra_css = 'padding: 3.5px;vertical-align:top;')  %>%
    row_spec(1, extra_css = 'padding: 5px;vertical-align:top;border-bottom: 1px solid black;') %>%
    row_spec(c(3,9),bold = T, background = icespal[['lg']], extra_css = 'padding: 5px;vertical-align:top;') %>%
    row_spec(c(4:8,10,11), extra_css = 'padding: 5px;vertical-align:top;') %>%
    column_spec(1, width = "10cm",extra_css = 'padding-right: 10px;vertical-align:top;') %>%
    column_spec(2:ncol(tab2), width = "4.5cm")
  
  

```
\* Risks to VMEs are not currently quantifiable due to no agreed metrics. <br>

#### VME Habitat and Indicator consequences
```{r, biological table}

source(paste(pathdir,"Utilities/Compile_table4.R",sep="/"))
tab4  %>%
  kable('html',escape = FALSE, align='l',row.names = FALSE) %>%
  kable_classic(full_width = F, position = "center",
                fixed_thead = T,font_size = 10,
                html_font = "Times") %>%
  row_spec(0, bold = T, 
           extra_css = 'padding: 3.5px;vertical-align:top;')  %>%
  row_spec(c(1,nhab+2),bold = T, background = icespal[['lg']], extra_css = 'padding: 5px;vertical-align:top;') %>%
  column_spec(1, width = "5cm",extra_css = 'padding-right: 10px;vertical-align:top;') %>%
  add_header_above(c(" " = 1, "Percent of total observations included in VME polygons" = 5),bold = TRUE)

```


### Interpretation of results {.tabset } 
```{r , results = 'asis'}
tt <- subset(textreg,textreg$Tab == "Interpretation")
for(i in 1:nrow(tt)){
  cat(tt[i,3])
  }
```

